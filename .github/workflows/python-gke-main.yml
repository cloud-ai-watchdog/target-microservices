name: Deploy Python App to GKE with Helm

on:
  workflow_dispatch:
  workflow_call:
    inputs:
      GCP_PROJECT_ID:
        type: string
        required: false
      GKE_CLUSTER_NAME:
        type: string
        required: false
      GKE_CLUSTER_ZONE:
        type: string
        required: false
      GAR_LOCATION:
        type: string
        required: false
      GAR_LOCATION_PREFIX:
        type: string
        required: false
      SERVICE_ACCOUNT:
        type: string
        required: false

jobs:
  read-config:
    runs-on: ubuntu-latest
    outputs:
      image_matrix: ${{ steps.set-matrix.outputs.image_matrix }}
      helm_matrix: ${{ steps.set-matrix.outputs.helm_matrix }}
      gcp_project_id: ${{ steps.set-vars.outputs.gcp_project_id }}
      gke_cluster_name: ${{ steps.set-vars.outputs.gke_cluster_name }}
      gke_cluster_zone: ${{ steps.set-vars.outputs.gke_cluster_zone }}
      gke_location: ${{ steps.set-vars.outputs.gke_location }}
      gar_location: ${{ steps.set-vars.outputs.gar_location }}
      gar_location_prefix: ${{ steps.set-vars.outputs.gar_location_prefix }}
      service_account: ${{ steps.set-vars.outputs.service_account }}
    steps:
      - uses: actions/checkout@v3
      - name: Read image and helm configurations
        id: set-matrix
        run: |
          set -e
          echo "üìù Reading configurations..."
          IMAGES_JSON=$(yq e -o=json '.images' .github/utils-cicd/image-configs.yaml | jq -c .)
          HELM_JSON=$(yq e -o=json '.releases' .github/utils-cicd/helm-configs.yaml | jq -c .)
          echo "Image Matrix JSON: $IMAGES_JSON"
          echo "Helm Matrix JSON: $HELM_JSON"
          echo "::set-output name=image_matrix::$IMAGES_JSON"
          echo "::set-output name=helm_matrix::$HELM_JSON"
          echo "‚úÖ Configurations read successfully."
      - name: Set common variables
        id: set-vars
        run: |
          set -e
          echo "üìù Setting common variables..."
          GCP_PROJECT_ID_DEFAULT=$(yq e '.GCP_PROJECT_ID' .github/utils-cicd/default-common-configs.yaml)
          GKE_CLUSTER_NAME_DEFAULT=$(yq e '.GKE_CLUSTER_NAME' .github/utils-cicd/default-common-configs.yaml)
          GKE_CLUSTER_ZONE_DEFAULT=$(yq e '.GKE_CLUSTER_ZONE' .github/utils-cicd/default-common-configs.yaml)
          GAR_LOCATION_DEFAULT=$(yq e '.GAR_LOCATION' .github/utils-cicd/default-common-configs.yaml)
          GAR_LOCATION_PREFIX_DEFAULT=$(yq e '.GAR_LOCATION_PREFIX' .github/utils-cicd/default-common-configs.yaml)
          SERVICE_ACCOUNT_DEFAULT=$(yq e '.SERVICE_ACCOUNT' .github/utils-cicd/default-common-configs.yaml)

          if [ -z "${{ inputs.GCP_PROJECT_ID }}" ]; then GCP_PROJECT_ID="$GCP_PROJECT_ID_DEFAULT"; else GCP_PROJECT_ID="${{ inputs.GCP_PROJECT_ID }}"; fi
          if [ -z "${{ inputs.GKE_CLUSTER_NAME }}" ]; then GKE_CLUSTER_NAME="$GKE_CLUSTER_DEFAULT"; else GKE_CLUSTER_NAME="${{ inputs.GKE_CLUSTER_NAME }}"; fi
          if [ -z "${{ inputs.GKE_CLUSTER_ZONE }}" ]; then GKE_CLUSTER_ZONE="$GKE_CLUSTER_ZONE_DEFAULT"; else GKE_CLUSTER_ZONE="${{ inputs.GKE_CLUSTER_ZONE }}"; fi
          if [ -z "${{ inputs.GAR_LOCATION }}" ]; then GAR_LOCATION="$GAR_LOCATION_DEFAULT"; else GAR_LOCATION="${{ inputs.GAR_LOCATION }}"; fi
          if [ -z "${{ inputs.GAR_LOCATION_PREFIX }}" ]; then GAR_LOCATION_PREFIX="$GAR_LOCATION_PREFIX_DEFAULT"; else GAR_LOCATION_PREFIX="${{ inputs.GAR_LOCATION_PREFIX }}"; fi
          if [ -z "${{ inputs.SERVICE_ACCOUNT }}" ]; then SERVICE_ACCOUNT="$SERVICE_ACCOUNT_DEFAULT"; else SERVICE_ACCOUNT="${{ inputs.SERVICE_ACCOUNT }}"; fi
          
          echo "Final GCP_PROJECT_ID: $GCP_PROJECT_ID"
          echo "Final GKE_CLUSTER_NAME: $GKE_CLUSTER_NAME"
          echo "Final GKE_CLUSTER_ZONE: $GKE_CLUSTER_ZONE"
          echo "Final GAR_LOCATION: $GAR_LOCATION"
          echo "Final GAR_LOCATION_PREFIX: $GAR_LOCATION_PREFIX"
          echo "Final SERVICE_ACCOUNT: $SERVICE_ACCOUNT"

          echo "::set-output name=gcp_project_id::$GCP_PROJECT_ID"
          echo "::set-output name=gke_cluster_name::$GKE_CLUSTER_NAME"
          echo "::set-output name=gke_cluster_zone::$GKE_CLUSTER_ZONE"
          echo "::set-output name=gar_location::$GAR_LOCATION"
          echo "::set-output name=gar_location_prefix::$GAR_LOCATION_PREFIX"
          echo "::set-output name=service_account::$SERVICE_ACCOUNT"
          echo "‚úÖ Common variables set."

  deploy-to-gke:
    name: Build and Deploy to GKE
    needs: read-config
    if: ${{ !contains(github.event.head_commit.message, '[skip-ci]') }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include: ${{fromJson(needs.read-config.outputs.image_matrix)}}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Authenticate with GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
          service_account: ${{ needs.read-config.outputs.service_account }}

      - name: Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ needs.read-config.outputs.gcp_project_id }}

      - name: Configure Docker for Google Artifact Registry
        run: |
          set -ex
          echo "üîê Configuring Docker for GAR..."
          gcloud auth configure-docker ${{ needs.read-config.outputs.gar_location_prefix }}
          echo "‚úÖ Docker configured."

      # -------------------------
      # BUILD AND PUSH IMAGE
      # -------------------------
      - name: Build Docker Image
        run: |
          set -ex
          echo "üî® Building Docker image: ${{ matrix.IMAGE_NAME }}:${{ matrix.IMAGE_TAG }}"
          docker build -f ${{ matrix.DOCKER_FILE }} -t ${{ needs.read-config.outputs.gar_location }}/${{ matrix.IMAGE_NAME }}:${{ matrix.IMAGE_TAG }} ${{ matrix.DOCKER_CONTEXT_DIR }}
          echo "‚úÖ Docker image built."
          docker images

      - name: Push Docker Image to Artifact Registry
        run: |
          set -ex
          echo "üöÄ Pushing Docker image to GAR: ${{ needs.read-config.outputs.gar_location }}/${{ matrix.IMAGE_NAME }}:${{ matrix.IMAGE_TAG }}"
          docker push ${{ needs.read-config.outputs.gar_location }}/${{ matrix.IMAGE_NAME }}:${{ matrix.IMAGE_TAG }}
          echo "‚úÖ Docker image pushed."

  deploy-helm:
    name: Deploy Helm Chart
    needs: [read-config, deploy-to-gke]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include: ${{fromJson(needs.read-config.outputs.helm_matrix)}}
    steps:
      # -------------------------
      # DEPLOY WITH HELM
      # -------------------------
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Authenticate with GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
          service_account: ${{ needs.read-config.outputs.service_account }}

      - name: Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ needs.read-config.outputs.gcp_project_id }}
        
      - name: Get GKE Credentials
        run: |
          set -ex
          echo "üîê Getting GKE credentials for cluster ${{ needs.read-config.outputs.gke_cluster_name }}..."
          gcloud components install kubectl --quiet
          gcloud components install gke-gcloud-auth-plugin --quiet
          # Install helm
          curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
          helm version
          gcloud container clusters get-credentials ${{ needs.read-config.outputs.gke_cluster_name }} --region ${{ needs.read-config.outputs.gke_cluster_zone }}
          echo "‚úÖ GKE credentials obtained."

      - name: Helm Dry Run
        run: |
          set -ex
          echo "üß™ Performing Helm dry run for release: ${{ matrix.HELM_RELEASE_NAME }}..."
          helm upgrade --install ${{ matrix.HELM_RELEASE_NAME }} ${{ matrix.HELM_CHART_DIR }} \
            --namespace ${{ matrix.HELM_NAMESPACE }} --create-namespace \
            --dry-run
          echo "‚úÖ Helm dry run completed."

      - name: Deploy with Helm
        run: |
          set -ex
          echo "üöÄ Deploying Helm chart for release: ${{ matrix.HELM_RELEASE_NAME }}..."
          helm upgrade --install ${{ matrix.HELM_RELEASE_NAME }} ${{ matrix.HELM_CHART_DIR }} \
            --namespace ${{ matrix.HELM_NAMESPACE }} --create-namespace
          echo "‚úÖ Helm chart deployed."
